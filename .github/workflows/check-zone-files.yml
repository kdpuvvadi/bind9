name: Check Zone Files

on:
  pull_request:
    paths:
      - 'config/*.zone'
      - 'config/named.conf'
      - '.github/workflows/check-zone-files.yml'

jobs:
  validate-zones:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install BIND utilities
        run: sudo apt-get update && sudo apt-get install -y bind9-utils

      - name: Validate zone files
        run: |
          set -e
          for zone_file in config/*.zone; do
            echo "Checking $zone_file..."
            # Extract zone name from filename
            zone_name=$(basename "$zone_file" .zone | sed 's/-/./g')
            zone_name="${zone_name}."
            
            if ! named-checkzone "$zone_name" "$zone_file"; then
              echo "❌ Zone file validation failed: $zone_file"
              exit 1
            fi
            echo "✓ $zone_file is valid"
          done
          echo "✅ All zone files are valid"

      - name: Validate named.conf
        run: |
          if [ -f config/named.conf ]; then
            echo "Checking config/named.conf..."
            # Create required BIND directories
            sudo mkdir -p /var/cache/bind
            sudo mkdir -p /var/lib/bind
            sudo chmod 755 /var/cache/bind /var/lib/bind
            
            if ! named-checkconf config/named.conf; then
              echo "❌ named.conf validation failed"
              exit 1
            fi
            echo "✅ named.conf is valid"
          fi
